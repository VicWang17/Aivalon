# Todo｜AI 阿瓦隆（Vue + FastAPI）

说明：本清单按“从能玩（MVP）→ 可复盘 → 高并发/异步与中间件完整落地”的顺序组织。每个阶段都应保持可运行、可演示。

## 0. 项目骨架（初始化）
- [X] 初始化前端工程（Vue 3 + TS + Vite）
- [X] 初始化后端工程（FastAPI + Uvicorn）
- [X] 约定前后端接口规范（REST + WebSocket 事件格式）
- [X] Docker Compose 启动 MySQL / Redis / RabbitMQ
- [X] 接入数据库迁移（Alembic）并跑通首次 migration
- [X] 为业务类文件添加功能描述注释

## 1. M1｜能开局能结束（基础可玩）

### 1.1 账号与鉴权
- [X] 用户注册（用户名/邮箱/密码）与登录
- [X] 登录态（JWT 或等价 token）与后端鉴权中间件
- [X] 前端登录态存储与自动带 token

### 1.2 对局状态机（核心）
- [X] 定义对局状态与阶段（选队长/发言/提名/投票/执行/刺杀/结算）
- [X] 定义动作类型（提名/投票/执行成功失败/刺杀/发言）
- [X] 动作权限校验（阶段正确、轮到谁、角色是否允许）
- [X] 超时与兜底策略（默认超时自动投票/自动执行）

### 1.3 HTTP API（MVP）
- [ ] 创建对局接口（返回 game_id 与初始快照）
- [ ] 获取对局快照接口（支持刷新后恢复）
- [ ] 提交动作接口（统一 actions 入口）

### 1.4 前端页面（MVP）
- [ ] 登录/注册页
- [ ] 首页（开始一局入口）
- [ ] 对局页（展示阶段、队长、队伍、投票、任务进度）
- [ ] 对局页动作面板（投票/执行/刺杀/发言按权限展示）

## 2. M2｜实时对局 + 可复盘（事件驱动落库）

### 2.1 WebSocket 实时
- [ ] WebSocket 鉴权与加入房间（/ws/games/{game_id}）
- [ ] 房间广播事件（对局推进、投票结果、任务结果、系统播报）
- [ ] 断线重连流程（HTTP 拉快照 + WS 收增量）

### 2.2 事件表与回放
- [ ] 设计并落地 game_events（追加写、顺序字段 seq）
- [ ] 每个动作写入事件表并广播事件
- [ ] 对局结束写入 games 元信息（胜负、阵营、角色揭示策略）
- [ ] 对局历史列表接口（按用户分页、筛选）
- [ ] 对局详情回放接口（按 seq 返回事件流）
- [ ] 前端历史页 + 回放页（时间轴/事件流渲染）

### 2.3 AI（先规则后人设）
- [ ] 规则型 AI（无大模型）：提名/投票/执行/刺杀全流程能跑通
- [ ] 7 个 AI persona 配置（风险偏好/表达强度/逻辑倾向/记忆窗口）
- [ ] AI 可选发言（先模板化台词，后续再升级）

## 3. M3｜Redis 落地（缓存、会话、热榜）

### 3.1 Redis 会话与限流
- [ ] 基于 Redis 的接口限流（登录、创建对局、动作提交）
- [ ] 幂等键（避免重复提交导致重复推进状态）

### 3.2 热榜（Sorted Set）
- [ ] 定义积分规则（胜场/胜率/ELO/连胜至少一种）
- [ ] Redis Sorted Set 存储热榜（按赛季 key 组织）
- [ ] 热榜查询接口（Top N + 本人排名）
- [ ] 前端热榜页

### 3.3 缓存策略
- [ ] 对局历史/详情查询的索引与分页优化（MySQL）
- [ ] 热点读缓存（热榜、最近对局摘要）

## 4. M4｜RabbitMQ + Celery（异步统计、AI 推理削峰、可靠性）

### 4.1 异步任务链路
- [ ] RabbitMQ 队列规划（统计队列、AI 队列、延时/重试/死信）
- [ ] Celery worker 启动与基本任务跑通
- [ ] 对局结束事件投递统计任务（更新热榜、写战绩聚合）

### 4.2 AI 推理任务化
- [ ] AI 行动由“投递任务 → worker 决策 → 回写动作”驱动
- [ ] AI 超时兜底（worker 超时或失败时走保底策略）
- [ ] 控制并发与背压（AI 队列 worker 并发上限）

### 4.3 可靠性（面试亮点）
- [ ] Outbox 表（MySQL）落地并实现消息转发器
- [ ] 消费端幂等（按 event_id/task_id 去重）
- [ ] 失败重试与告警策略（死信队列 + 可观测指标）

## 5. 质量保障（贯穿全程）

### 5.1 测试
- [ ] 对局状态机单元测试（覆盖关键规则与边界）
- [ ] API 集成测试（创建对局到结束）
- [ ] 并发测试用例（重复提交、乱序提交、断线重连）

### 5.2 可观测性
- [ ] 结构化日志（请求 id / game_id / user_id）
- [ ] 指标：WS 连接数、房间数、事件写入速率、队列堆积、AI 推理耗时
- [ ] 慢查询与索引检查（MySQL）

### 5.3 性能与安全
- [ ] 压测热榜与历史接口（记录 P95/P99）
- [ ] 鉴权与权限校验全链路补齐（所有 action 强校验）
- [ ] 敏感信息脱敏（日志与响应）

## 6. 选做（V1+）
- [ ] 观战模式（只读订阅 WS 事件流）
- [ ] 赛季机制（定期归档热榜快照）
- [ ] 复盘摘要任务（对局结束异步生成“关键转折点”）
- [ ] 匹配大厅（真人匹配扩展）

