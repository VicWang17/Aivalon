# PRD｜Aivalon (AI Avalon)

## 1. 背景与目标

### 1.1 背景
- 阿瓦隆（Avalon）是强社交推理玩法，核心乐趣来自“信息不对称 + 立场对抗 + 发言与投票的博弈”。
- 本项目提供“1 名真人玩家 + 7 名 AI”对局体验，AI 具备可区分的人设、心态与行为风格，并提供完整对局回放与热榜。

### 1.2 产品目标
- 可玩：用户能快速发起对局，完成从入局到结算的完整流程。
- 可复盘：每局可回放所有关键事件与发言，支持对局历史检索。
- 可增长：热榜与战绩页形成可分享、可对比的目标机制。
- 可扩展：面向高并发与异步任务设计，为后续“更多玩家/更多局并发/更多 AI 模型”留出空间。

### 1.3 成功指标（MVP）
- 单局 8 人（1 真人 + 7 AI）可稳定进行，核心规则正确率 100%（以自动化用例覆盖为准）。
- 对局结束后 1 秒内可在历史页看到该局记录（至少看到基本信息与回放入口）。
- 热榜接口 P95 响应 < 50ms（在本地/单机压测条件下）。

### 1.4 技术选型（落地方案）
- 前端：Vue 3 + TypeScript + Vite
- 状态与路由：Pinia + Vue Router
- UI：Element Plus
- 后端：Python 3.11+ + FastAPI + Uvicorn
- 数据库：MySQL 8（InnoDB）
- ORM 与迁移：SQLAlchemy 2 + Alembic
- 缓存：Redis 7（会话、限流、热榜 Sorted Set）
- 消息队列：RabbitMQ 3（异步统计、AI 推理任务、延时/重试/死信）
- 异步任务：Celery（broker=RabbitMQ，result backend=Redis/DB 二选一）
- 部署：Docker Compose（本地一键启动 MySQL/Redis/RabbitMQ）

## 2. 用户与场景

### 2.1 目标用户
- 轻度推理玩家：想快速开局体验推理过程。
- 复盘型玩家：希望回看关键票型/队伍组合与败因。
- 面试评审/技术同学：关注系统设计、工程质量、可观测性与可扩展性。

### 2.2 典型使用路径
- 登录/注册 → 首页点击“开始一局” → 进入对局页（实时更新） → 对局结束结算 → 查看对局详情回放 → 查看个人战绩/热榜。

## 3. 玩法与规则范围

### 3.1 对局配置（MVP）
- 固定 8 人：1 真人 + 7 AI。
- 固定角色集合：梅林、派西维尔、忠臣 ×3、刺客、莫甘娜、爪牙。
- 固定任务轮数：5 轮任务，按阿瓦隆标准胜负条件结算。
- 发言：MVP 可做“系统播报 + AI 可选发言”，真人可发言。

### 3.2 回合流程（抽象）
- 选队长 → 队长提名执行队伍 → 全体投票通过/否决 → 若通过则执行队伍成员提交成功/失败 → 更新任务进度 → 进入下一轮或结算 → 若好人完成 3 次任务成功进入刺杀环节。

### 3.3 可配置项（V1）
- AI 风格/难度：保守、激进、话痨、沉默、逻辑控、情绪型、欺诈型等。
- 计时器：投票/出队/发言默认超时与自动处理策略。

## 4. 需求范围与功能列表

### 4.1 必做（MVP）
#### A. 账户与基础
- 登录/注册（邮箱验证 + 用户名 + 密码）。
- 用户信息：昵称、头像（二进制生成）、创建时间。
- 安全（暂时不做）：基础防刷（限流/验证码可选），敏感信息不落日志。

#### B. 开局与对局
- 发起一局：创建房间并进入对局。
- 对局页实时更新：阶段、队长、提名队伍、投票状态、任务结果、当前任务进度、可操作面板。
- 真人可操作：
  - 参与投票（队伍通过/否决）。
  - 若真人在执行队伍中，提交成功/失败（按角色限制）。
  - 若真人为刺客，结算阶段可选择刺杀目标。
  - 文本发言。
- AI 自动操作：
  - 在超时或轮到其行动时自动完成操作。
  - 可输出“理由/台词”。

#### C. 对局历史与回放
- 对局历史列表：按时间倒序、支持筛选（胜负、阵营、角色）。
- 对局详情回放：按事件顺序展示关键节点（提名、投票、出队、任务、刺杀、结算）。

#### D. 热榜
- 热榜维度（至少一个）：胜场、胜率、ELO/积分、连胜。
- 热榜展示：Top N + 本人排名。

### 4.2 选做（V1+）
- 匹配大厅（暂时不做）：多人同时在线匹配真人（扩展点）。
- 观战模式：只读加入房间，接收事件流。
- 赛季机制：按周期重置热榜。
- AI 训练/回放评估：对局后生成“复盘摘要”。

## 5. 页面与交互（Vue）

### 5.1 页面清单
- 登录/注册页
- 首页（开始一局、最近对局、热榜入口）
- 对局页（WebSocket 实时）
- 对局历史页（列表）
- 对局详情/回放页（时间轴/事件流）
- 热榜页
- 个人中心（战绩汇总，可选）

### 5.2 对局页关键交互
- 状态区域：当前回合、当前队长、任务进度（好人成功次数/坏人失败次数/否决次数）。
- 行动区域：投票按钮、提交成功/失败按钮、刺杀选择（仅在权限与阶段满足时显示）。
- 事件流区域：系统播报与发言记录（按时间顺序）。
- 断线重连：刷新后通过 HTTP 拉取当前对局快照，再通过 WS 继续接收增量事件。

## 6. 后端能力与接口（FastAPI）

### 6.1 模块边界（建议）
- Auth：注册、登录、token 校验。
- Game：创建对局、查询对局快照、对局历史、对局详情（事件流）。
- Realtime：WebSocket 连接、房间广播、鉴权、重连补发。
- AI Orchestrator：AI 决策任务投递、超时兜底策略。
- Leaderboard：热榜查询、统计任务消费更新。

### 6.2 核心数据读写方式（事件驱动）
- 写：玩家/AI 的动作统一写入“事件表”，由房间状态机消费事件推进状态并广播。
- 读：
  - 对局页：读“快照 + 增量事件”。
  - 回放页：读全量事件流重放渲染。

### 6.3 API（示例级）
- POST /api/auth/register
- POST /api/auth/login
- POST /api/games （创建对局）
- GET /api/games/{game_id} （对局快照）
- POST /api/games/{game_id}/actions （提交动作：提名/投票/执行/刺杀/发言）
- GET /api/games/{game_id}/events?after={event_id} （增量事件）
- GET /api/users/me
- GET /api/users/me/games （我的对局历史）
- GET /api/leaderboard （热榜）
- WS /ws/games/{game_id} （实时事件）

## 7. AI 设计（7 个 AI 人设与“心态”）

### 7.1 目标
- “可区分”：玩家能感知不同 AI 的稳定风格差异。
- “可解释”：关键动作可生成一句理由，用于回放与教学。
- “可控”：支持难度/激进度/话痨度等参数配置与版本化。

### 7.2 人设维度（建议参数化）
- 风险偏好：保守/激进（影响投票、出队冒险程度）。
- 表达强度：沉默/正常/话痨（影响发言频率与长度）。
- 逻辑倾向：概率派/规则派/情绪派（影响理由与行为一致性）。
- 复仇/对抗心态：被否决多次后更极端（影响后续投票）。
- 记忆能力：对票型/队伍的记忆窗口长度（影响推理能力）。

### 7.3 决策执行
- AI 决策输入：当前房间快照、历史事件摘要、AI 自身 persona、私有信息（角色与阵营）。
- AI 决策输出：动作（投票/提名/成功失败/刺杀/发言）+ 可选理由文本。
- 超时兜底：若 AI 推理任务超时，按“保底策略”执行（例如随机但受约束、或简化规则策略）。

## 8. 数据设计（MySQL）

### 8.1 核心表（建议）
- users：用户信息
- games：对局元信息（创建者、开始/结束时间、最终结果、版本号）
- game_players：对局内座位与角色信息（可延迟揭示字段，用于回放阶段展示）
- game_events：事件流（追加写，包含 event_type、payload、created_at、seq）
- leaderboard_snapshots（可选）：热榜快照归档

### 8.2 索引建议
- game_events：game_id + seq（或 created_at）联合索引，支持顺序回放与增量拉取。
- games：user_id + created_at，支持用户历史分页。

## 9. Redis、消息队列与高并发设计

### 9.1 Redis（职责）
- 登录态与限流：token/session、IP/账号维度限流计数。
- 热榜：Sorted Set（例如 zset:leaderboard:season:{id}）。
- 对局短期状态（可选）：房间在线成员、WS 连接映射、短期幂等键。

### 9.2 消息队列（职责）
- 异步统计：对局结束事件 → 更新热榜/战绩聚合。
- AI 推理任务：把 AI 行动请求投递到队列，控制并发与重试，避免阻塞对局主链路。
- 可靠性：建议使用“Outbox + 幂等消费”保证消息不丢且不重复结算。

### 9.3 高并发关键点
- 房间“单写者/Actor”串行推进状态，减少锁竞争与并发 bug。
- 读写分离：热榜/历史页大多走缓存与索引，减少对主库压力。
- 背压与降级：WS 广播限频、AI 推理超时兜底、统计任务可延迟。

## 10. 安全与合规
- 密码哈希存储（不明文、不可逆）。
- 鉴权：HTTP Bearer Token + WS 握手鉴权。
- 权限校验：每个 action 必须校验“是否轮到你/是否有该角色权限/是否在正确阶段”。
- 防刷：登录、创建对局、动作提交接口做限流与幂等。

## 11. 非功能性需求（NFR）
- 可用性：断线重连后可恢复对局并继续操作。
- 一致性：同一房间内事件顺序一致、状态机推进正确。
- 性能：热榜与历史查询高频接口缓存命中率可观测。
- 可观测性：关键链路打点（对局创建、动作提交、WS 广播、AI 推理耗时、队列积压）。

## 12. 里程碑（建议）
- M1：账号 + 开局 + 对局状态机 + 基础 UI
- M2：WS 实时对局 + 事件流落库 + 回放页
- M3：Redis 热榜 + MQ 异步统计 + 压测与观测
- M4：AI 人设参数化 + 复盘摘要（选做）
